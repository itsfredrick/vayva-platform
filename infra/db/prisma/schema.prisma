generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AbuseRule {
  id String @id @default(uuid())
  key       String   @unique
  enabled   Boolean  @default(true)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminAuditLog {
  id String @id @default(uuid())
  actorUserId String
  action      String
  targetType  String?
  targetId    String?
  storeId     String?
  reason      String?
  before      Json?
  after       Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([actorUserId, createdAt])
  @@index([createdAt])
  @@index([storeId, createdAt])
}

model AiActionDefinition {
  id String @id @default(uuid())
  triggerType String
  name        String
  description String
  toolConfig  Json
  createdAt   DateTime @default(now())
}

model AiActionMessageLink {
  id String @id @default(uuid())
  messageId     String
  aiActionRunId String
  relationType  String
  Message       Message @relation(fields: [messageId], references: [id])
}

model AiActionRun {
  id String @id @default(uuid())
  storeId          String
  conversationId   String
  actionDefId      String
  status           AiActionStatus @default(PROPOSED)
  arguments        Json
  requiresApproval Boolean        @default(false)
  result           Json?
  error            String?
  createdAt        DateTime       @default(now())
  updatedAt DateTime @updatedAt
  Conversation     Conversation   @relation(fields: [conversationId], references: [id])
  store            Store          @relation(fields: [storeId], references: [id])

  @@index([storeId, status])
}

model AnalyticsDailyDelivery {
  id String @id @default(uuid())
  storeId             String
  date                DateTime @db.Date
  shipmentsDispatched Int      @default(0)
  shipmentsDelivered  Int      @default(0)
  shipmentsFailed     Int      @default(0)
  deliverySuccessRate Decimal? @db.Decimal(5, 2)
  avgDeliveryHours    Decimal? @db.Decimal(8, 2)
  kwikShare           Decimal? @db.Decimal(5, 2)
  selfDispatchShare   Decimal? @db.Decimal(5, 2)
  createdAt           DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model AnalyticsDailyPayments {
  id String @id @default(uuid())
  storeId               String
  date                  DateTime @db.Date
  successCount          Int      @default(0)
  failedCount           Int      @default(0)
  successAmount         Decimal  @default(0) @db.Decimal(12, 2)
  failedAmount          Decimal  @default(0) @db.Decimal(12, 2)
  avgPaymentTimeSeconds Int?
  createdAt             DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model AnalyticsDailySales {
  id String @id @default(uuid())
  storeId             String
  date                DateTime @db.Date
  ordersCount         Int      @default(0)
  grossSales          Decimal  @default(0) @db.Decimal(12, 2)
  discounts           Decimal  @default(0) @db.Decimal(12, 2)
  shipping            Decimal  @default(0) @db.Decimal(12, 2)
  netSales            Decimal  @default(0) @db.Decimal(12, 2)
  refunds             Decimal  @default(0) @db.Decimal(12, 2)
  paidOrdersCount     Int      @default(0)
  codOrdersCount      Int      @default(0)
  transferOrdersCount Int      @default(0)
  createdAt           DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model AnalyticsDailySupport {
  id String @id @default(uuid())
  storeId                 String
  date                    DateTime @db.Date
  inboundMessages         Int      @default(0)
  outboundMessages        Int      @default(0)
  firstResponseAvgSeconds Int?
  ticketsCreated          Int      @default(0)
  ticketsResolved         Int      @default(0)
  resolutionAvgSeconds    Int?
  unreadConversationsEOD  Int      @default(0)
  createdAt               DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model ApiKey {
  id String @id @default(uuid())
  storeId    String
  name       String
  keyHash    String       @unique
  scopes     String[]
  status     ApiKeyStatus @default(ACTIVE)
  lastUsedAt DateTime?
  createdAt  DateTime     @default(now())
  revokedAt  DateTime?

  @@index([storeId, status])
}

model AutomationRule {
  id String @id @default(uuid())
  storeId   String
  key       String
  enabled   Boolean  @default(false)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, key])
}

model BankBeneficiary {
  id String @id @default(uuid())
  storeId       String
  bankCode      String
  bankName      String
  accountNumber String
  accountName   String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt DateTime @updatedAt
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model BillingProfile {
  id String @id @default(uuid())
  storeId      String   @unique
  legalName    String?
  addressText  String?
  taxId        String?
  billingEmail String?
  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Campaign {
  id String @id @default(uuid())
  storeId            String
  type               CampaignType
  channel            CampaignChannel
  name               String
  status             CampaignStatus  @default(DRAFT)
  segmentId          String?
  scheduledAt        DateTime?
  quietHours         Json?
  messageTemplateKey String?
  messageBody        String
  variables          Json?
  createdByUserId    String
  createdAt          DateTime        @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, status])
}

model CampaignSend {
  id String @id @default(uuid())
  storeId           String
  campaignId        String
  customerId        String?
  toAddress         String
  status            CampaignSendStatus @default(QUEUED)
  providerMessageId String?
  errorCode         String?
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, toAddress])
  @@index([storeId, status])
}

model CarrierAccount {
  id String @id @default(uuid())
  storeId        String
  carrier        String
  status         String   @default("DISCONNECTED")
  credentialsEnc String?
  createdAt      DateTime @default(now())
  updatedAt DateTime @updatedAt
  store          Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, carrier])
}

model Charge {
  id String @id @default(uuid())
  storeId          String
  orderId          String?
  paymentIntentId  String?
  provider         String
  providerChargeId String
  status           String         @default("PENDING")
  amount           Decimal        @db.Decimal(10, 2)
  currency         String
  paidAt           DateTime?
  failureCode      String?
  failureMessage   String?
  receiptUrl       String?
  createdAt        DateTime       @default(now())
  updatedAt DateTime @updatedAt
  PaymentIntent    PaymentIntent? @relation(fields: [paymentIntentId], references: [id])
  store            Store          @relation(fields: [storeId], references: [id])
  Refund           Refund[]

  @@unique([provider, providerChargeId])
}

model Collection {
  id String @id @default(uuid())
  storeId           String
  title             String
  handle            String
  description       String?
  createdAt         DateTime            @default(now())
  updatedAt DateTime @updatedAt
  store             Store               @relation(fields: [storeId], references: [id])
  CollectionProduct CollectionProduct[]

  @@unique([storeId, handle])
}

model CollectionProduct {
  collectionId String
  productId    String
  Collection   Collection @relation(fields: [collectionId], references: [id])
  Product      Product    @relation(fields: [productId], references: [id])

  @@id([collectionId, productId])
}

model Contact {
  id String @id @default(uuid())
  storeId      String
  channel      Channel        @default(WHATSAPP)
  externalId   String
  displayName  String?
  phoneE164    String?
  lastSeenAt   DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt DateTime @updatedAt
  store        Store          @relation(fields: [storeId], references: [id])
  Conversation Conversation[]

  @@unique([storeId, channel, externalId])
}

model Conversation {
  id String @id @default(uuid())
  storeId              String
  contactId            String
  status               String                 @default("OPEN")
  assignedTo           String?
  unreadCount          Int                    @default(0)
  lastMessageAt        DateTime               @default(now())
  lastInboundAt        DateTime?
  lastOutboundAt       DateTime?
  lastRepliedAt        DateTime?
  priority             String                 @default("normal")
  tags                 Json                   @default("[]")
  createdAt            DateTime               @default(now())
  updatedAt DateTime @updatedAt
  aiActionRuns         AiActionRun[]
  contact              Contact                @relation(fields: [contactId], references: [id])
  store                Store                  @relation(fields: [storeId], references: [id])
  messages             Message[]
  conversation_tag_map conversation_tag_map[]
  internalNotes        InternalNote[]
  supportTickets       SupportTicket[]

  @@unique([storeId, contactId])
  @@index([storeId, lastMessageAt(sort: Desc)])
  @@index([storeId, unreadCount])
}

model Coupon {
  id String @id @default(uuid())
  storeId   String
  ruleId    String
  code      String
  status    CouponStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, code])
  @@index([storeId, status])
}

model CustomDomain {
  id String @id @default(uuid())
  storeId          String
  domain           String    @unique
  status           String    @default("pending_verification")
  verificationType String    @default("cname")
  expectedValue    String?
  lastCheckedAt    DateTime?
  createdAt        DateTime  @default(now())

  @@index([storeId])
}

model Customer {
  id String @id @default(uuid())
  storeId           String
  email             String?
  phone             String?
  firstName         String?
  lastName          String?
  whatsappContactId String?
  defaultAddressId  String?
  notes             String?
  tags              String[]
  marketingOptIn    Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt DateTime @updatedAt
  store             Store             @relation(fields: [storeId], references: [id])
  addresses         CustomerAddress[]
  orders            Order[]
  supportTickets    SupportTicket[]

  @@unique([storeId, email])
  @@unique([storeId, phone])
}

model CustomerAccount {
  id String @id @default(uuid())
  email           String?           @unique
  phone           String?           @unique
  firstName       String?
  lastName        String?
  isVerified      Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt DateTime @updatedAt
  CustomerSession CustomerSession[]
}

model CustomerAddress {
  id String @id @default(uuid())
  storeId        String
  customerId     String
  label          String?
  isDefault      Boolean  @default(false)
  recipientName  String?
  recipientPhone String?
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  country        String   @default("NG")
  createdAt      DateTime @default(now())
  updatedAt DateTime @updatedAt
  Customer       Customer @relation(fields: [customerId], references: [id])
  store          Store    @relation(fields: [storeId], references: [id])
}

model CustomerRiskProfile {
  id String @id @default(uuid())
  merchantId String
  customerId String?
  phoneE164  String?
  riskScore  Int      @default(0)
  flags      String[]
  updatedAt DateTime @updatedAt

  @@unique([merchantId, customerId])
}

model CustomerSession {
  id String @id @default(uuid())
  customerId      String
  token           String          @unique
  device          String?
  ipAddress       String?
  expiresAt       DateTime
  createdAt       DateTime        @default(now())
  CustomerAccount CustomerAccount @relation(fields: [customerId], references: [id])
}

model DataRequest {
  id String @id @default(uuid())
  storeId       String
  type          DataRequestType
  status        DataRequestStatus @default(SUBMITTED)
  requesterType String
  customerId    String?
  userId        String?
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt DateTime @updatedAt
  completedAt   DateTime?
}

model DeadLetterQueue {
  id String @id @default(uuid())
  storeId    String?
  jobType    String
  payload    Json
  lastError  String
  failedAt   DateTime  @default(now())
  retryAfter DateTime?
  status     DLQStatus @default(DEAD)
  replayedAt DateTime?

  @@index([status, failedAt])
  @@index([storeId, jobType])
}

model DeliveryOption {
  id String @id @default(uuid())
  storeId         String
  profileId       String
  type            String
  name            String
  description     String?
  enabled         Boolean         @default(true)
  etaMinDays      Int?
  etaMaxDays      Int?
  createdAt       DateTime        @default(now())
  updatedAt DateTime @updatedAt
  DeliveryProfile DeliveryProfile @relation(fields: [profileId], references: [id])
  store           Store           @relation(fields: [storeId], references: [id])
}

model DeliveryProfile {
  id String @id @default(uuid())
  storeId         String
  name            String           @default("General Profile")
  isDefault       Boolean          @default(true)
  defaultCurrency String           @default("NGN")
  createdAt       DateTime         @default(now())
  updatedAt DateTime @updatedAt
  DeliveryOption  DeliveryOption[]
  store           Store            @relation(fields: [storeId], references: [id])
  DeliveryZone    DeliveryZone[]
}

model DeliveryWebhookEvent {
  id String @id @default(uuid())
  storeId         String?
  carrier         String
  providerEventId String
  payload         Json
  status          String    @default("RECEIVED")
  error           String?
  receivedAt      DateTime  @default(now())
  processedAt     DateTime?

  @@unique([carrier, providerEventId])
}

model DeliveryZone {
  id String @id @default(uuid())
  storeId         String
  profileId       String
  name            String
  states          String[]
  cities          String[]
  feeType         String
  feeAmount       Decimal         @db.Decimal(10, 2)
  freeOverAmount  Decimal?        @db.Decimal(10, 2)
  etaMinDays      Int             @default(1)
  etaMaxDays      Int             @default(3)
  createdAt       DateTime        @default(now())
  updatedAt DateTime @updatedAt
  DeliveryProfile DeliveryProfile @relation(fields: [profileId], references: [id])
  store           Store           @relation(fields: [storeId], references: [id])
}

model DeviceRegistration {
  id String @id @default(uuid())
  storeId    String?
  userId     String?
  customerId String?
  deviceType DeviceType   @default(WEB_PUSH)
  pushToken  String       @unique
  status     DeviceStatus @default(ACTIVE)
  lastSeenAt DateTime     @default(now())
  createdAt  DateTime     @default(now())

  @@index([customerId, status])
  @@index([storeId, status])
  @@index([userId, status])
}

model DiscountRedemption {
  id String @id @default(uuid())
  storeId          String
  ruleId           String
  couponId         String?
  orderId          String
  customerId       String?
  amountDiscounted Decimal  @db.Decimal(10, 2)
  redeemedAt       DateTime @default(now())

  @@index([storeId, redeemedAt])
}

model DiscountRule {
  id String @id @default(uuid())
  storeId               String
  name                  String
  type                  DiscountType
  valueAmount           Decimal?          @db.Decimal(10, 2)
  valuePercent          Decimal?          @db.Decimal(5, 2)
  appliesTo             DiscountAppliesTo @default(ALL)
  productIds            String[]
  collectionIds         String[]
  minOrderAmount        Decimal?          @db.Decimal(10, 2)
  maxDiscountAmount     Decimal?          @db.Decimal(10, 2)
  currency              String            @default("NGN")
  startsAt              DateTime
  endsAt                DateTime?
  usageLimitTotal       Int?
  usageLimitPerCustomer Int?
  requiresCoupon        Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, startsAt])
}

model DispatchJob {
  id String @id @default(uuid())
  storeId            String
  shipmentId         String
  carrier            String
  providerJobId      String?
  status             String    @default("CREATED")
  assignedRiderName  String?
  assignedRiderPhone String?
  vehicleType        String?
  pickupEta          DateTime?
  deliveryEta        DateTime?
  podType            String    @default("NONE")
  podData            Json?
  createdAt          DateTime  @default(now())
  updatedAt DateTime @updatedAt
  Shipment           Shipment  @relation(fields: [shipmentId], references: [id])
  store              Store     @relation(fields: [storeId], references: [id])

  @@unique([carrier, providerJobId])
}

model Dispute {
  id                String          @id @default(uuid())
  merchantId        String
  storeId           String
  provider          DisputeProvider
  providerDisputeId String
  paymentId         String?
  orderId           String?
  customerId        String?
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("NGN")
  reasonCode        String?
  status            DisputeStatus   @default(OPENED)
  evidenceDueAt     DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  store             Store           @relation(fields: [storeId], references: [id])
  order             Order?          @relation(fields: [orderId], references: [id])

  @@unique([provider, providerDisputeId])
  @@index([merchantId, status])
  @@index([storeId])

  @@map("dispute")
}

model DisputeEvidence {
  id          String              @id @default(uuid())
  disputeId   String
  type        DisputeEvidenceType
  s3Key       String?
  url         String?
  textExcerpt String?
  metadata    Json?
  createdAt   DateTime            @default(now())

  @@map("dispute_evidence")
}

model DisputeTimelineEvent {
  id String @id @default(uuid())
  disputeId String
  eventType String
  payload   Json?
  createdAt DateTime @default(now())
}

model EnforcementAction {
  id String @id @default(uuid())
  merchantId String
  actorType  String                @default("SYSTEM")
  action     EnforcementActionType
  scope      EnforcementScope
  scopeId    String?
  reason     String?
  expiresAt  DateTime?
  createdAt  DateTime              @default(now())

  @@index([merchantId, action])
}

model EvidenceAsset {
  id String @id @default(uuid())
  bundleId       String
  type           EvidenceFileType
  s3Key          String?
  url            String?
  redactionLevel String           @default("NONE")
  createdAt      DateTime         @default(now())
}

model EvidenceBundle {
  id String @id @default(uuid())
  merchantId      String
  scope           EvidenceScope
  scopeId         String
  generatedBy     String        @default("SYSTEM")
  status          String        @default("READY")
  summary         Json?
  createdAt       DateTime      @default(now())
  updatedAt DateTime @updatedAt
  disputeId       String?
  returnRequestId String?
}

model ExportJob {
  id String @id @default(uuid())
  storeId       String
  dataRequestId String    @unique
  status        String
  s3Key         String?
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt DateTime @updatedAt
}

model GoLiveChecklistItem {
  id String @id @default(uuid())
  storeId       String
  key           String
  title         String
  description   String?
  category      ChecklistCategory
  status        ChecklistStatus   @default(TODO)
  blockerReason String?
  updatedAt DateTime @updatedAt

  @@unique([storeId, key])
  @@index([storeId, status])
}

model Goal {
  id String @id @default(uuid())
  storeId     String
  metricKey   String
  period      MetricPeriod
  targetValue Decimal      @db.Decimal(12, 2)
  startDate   DateTime     @db.Date
  endDate     DateTime?    @db.Date
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, isActive])
}

model HealthScore {
  id String @id @default(uuid())
  storeId    String
  date       DateTime @db.Date
  score      Int
  components Json
  createdAt  DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model IdempotencyKeyV2 {
  id String @id @default(uuid())
  storeId      String?
  scope        String
  key          String
  status       IdempotencyStatus @default(STARTED)
  responseHash String?
  responseJson Json?
  createdAt    DateTime          @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, scope, key])
  @@index([scope, key])
}

model InventoryEvent {
  id String @id @default(uuid())
  variantId      String
  action         String
  quantity       Int
  reason         String?
  createdAt      DateTime       @default(now())
  ProductVariant ProductVariant @relation(fields: [variantId], references: [id])
}

model InventoryItem {
  id String @id @default(uuid())
  locationId        String
  variantId         String
  productId         String
  onHand            Int               @default(0)
  reserved          Int               @default(0)
  available         Int               @default(0)
  reorderPoint      Int?
  updatedAt DateTime @updatedAt
  InventoryLocation InventoryLocation @relation(fields: [locationId], references: [id])
  Product           Product           @relation(fields: [productId], references: [id])
  ProductVariant    ProductVariant    @relation(fields: [variantId], references: [id])

  @@unique([locationId, variantId])
}

model InventoryLocation {
  id String @id @default(uuid())
  storeId           String
  name              String
  isDefault         Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt DateTime @updatedAt
  InventoryItem     InventoryItem[]
  store             Store               @relation(fields: [storeId], references: [id])
  InventoryMovement InventoryMovement[]
}

model InventoryMovement {
  id String @id @default(uuid())
  storeId           String
  locationId        String
  variantId         String
  type              String
  quantity          Int
  reason            String?
  referenceId       String?
  performedBy       String?
  createdAt         DateTime          @default(now())
  InventoryLocation InventoryLocation @relation(fields: [locationId], references: [id])
  store             Store             @relation(fields: [storeId], references: [id])

  @@index([storeId, variantId])
}

model InvoiceLineV2 {
  id String @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitAmount  Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)
  metadata    Json?
}

model InvoiceV2 {
  id String @id @default(uuid())
  storeId        String
  customerId     String?
  invoiceNumber  String        @unique
  status         String
  subtotalKobo   BigInt
  taxKobo        BigInt        @default(0)
  totalKobo      BigInt
  dueDate        DateTime?
  items          Json
  createdAt      DateTime      @default(now())
  updatedAt DateTime @updatedAt
  subscriptionId String?
  store          Store         @relation(fields: [storeId], references: [id])
  Subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([storeId])
}

model JobRun {
  id String @id @default(uuid())
  storeId       String?
  jobName       String
  correlationId String?
  attempt       Int          @default(1)
  status        JobRunStatus @default(RUNNING)
  startedAt     DateTime     @default(now())
  completedAt   DateTime?
  duration      Int?
  errorType     String?
  errorMessage  String?
  metadata      Json?

  @@index([jobName, status, startedAt])
  @@index([storeId, jobName])
}

model KnowledgeBaseEntry {
  id String @id @default(uuid())
  storeId    String
  content    String
  embedding  Json?
  sourceType String
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  store      Store    @relation(fields: [storeId], references: [id])
}

model KycRecord {
  id               String    @id @default(uuid())
  storeId          String    @unique
  ninLast4         String
  bvnLast4         String
  fullNinEncrypted String?
  fullBvnEncrypted String?
  status           KycStatus @default(NOT_STARTED)
  submittedAt      DateTime  @default(now())
  reviewedAt       DateTime?
  reviewedBy       String?
  rejectionReason  String?
  notes            String?
  audit            Json      @default("[]")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  store            Store     @relation(fields: [storeId], references: [id])
}

model LedgerEntry {
  id            String   @id @default(uuid())
  storeId       String
  referenceType String
  referenceId   String
  direction     String
  account       String
  amount        Decimal  @db.Decimal(10, 2)
  currency      String
  description   String?
  occurredAt    DateTime @default(now())
  metadata      Json?
  createdAt     DateTime @default(now())
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([storeId, account])
  @@index([storeId, occurredAt(sort: Desc)])
}

model LegalAcceptance {
  id String @id @default(uuid())
  storeId    String
  userId     String
  key        LegalKey
  version    Int
  ipAddress  String?
  userAgent  String?
  acceptedAt DateTime @default(now())
}

model LegalTemplate {
  id String @id @default(uuid())
  storeId   String?
  key       LegalKey
  title     String
  content   String
  version   Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, key, version])
}

model MarketplaceListing {
  id String @id @default(uuid())
  productId      String        @unique
  status         ListingStatus @default(UNLISTED)
  category       String?
  rankScore      Int           @default(0)
  moderationNote String?
  moderatedBy    String?
  createdAt      DateTime      @default(now())
  updatedAt DateTime @updatedAt
  Product        Product       @relation(fields: [productId], references: [id])
}

model MediaAsset {
  id String @id @default(uuid())
  storeId        String
  conversationId String
  messageId      String
  contentType    String
  filename       String?
  sizeBytes      Int?
  s3Key          String
  sha256         String?
  createdAt      DateTime @default(now())
  Message        Message  @relation(fields: [messageId], references: [id])
}

model Membership {
  id String @id @default(uuid())
  userId    String
  storeId   String
  role      String   @default("viewer")
  status    String   @default("active")
  roleId    String?
  role_enum AppRole  @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Role      Role?    @relation(fields: [roleId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, storeId])
  @@index([storeId])
}

model MerchantFeatureOverride {
  id String @id @default(uuid())
  storeId   String
  key       String
  value     Json
  reason    String
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, key])
  @@index([storeId])
}

model MerchantFlag {
  id String @id @default(uuid())
  storeId   String
  key       String
  severity  FlagSeverity @default(MEDIUM)
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, key])
}

model MerchantOnboarding {
  id String @id @default(uuid())
  storeId        String           @unique
  status         OnboardingStatus @default(NOT_STARTED)
  currentStepKey String?
  completedSteps String[]         @default([])
  data           Json             @default("{}")
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt
  store          Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
}

model MerchantPolicy {
  id String @id @default(uuid())
  merchantId       String
  storeId          String
  storeSlug        String
  type             PolicyType
  title            String
  contentMd        String
  contentHtml      String?
  status           PolicyStatus @default(DRAFT)
  publishedVersion Int          @default(0)
  publishedAt      DateTime?
  lastUpdatedLabel String?
  createdAt        DateTime     @default(now())
  updatedAt DateTime @updatedAt
  store            Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, type])
  @@index([merchantId])
  @@index([storeSlug])
  @@index([storeSlug, type, status])
}

model MerchantSession {
  id String @id @default(uuid())
  userId    String
  token     String   @unique
  device    String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model MerchantTheme {
  id String @id @default(uuid())
  storeId           String
  templateId        String
  templateVersionId String?
  status            ThemeStatus @default(DRAFT)
  config            Json        @default("{}")
  publishedAt       DateTime?
  appliedAt         DateTime    @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, templateId])
}

model MerchantThemeHistory {
  id String @id @default(uuid())
  storeId           String
  themeId           String
  templateId        String
  templateVersionId String?
  configSnapshot    Json
  changedByUserId   String?
  reason            String?
  createdAt         DateTime @default(now())
}

model Message {
  id String @id @default(uuid())
  storeId             String
  conversationId      String
  direction           Direction
  type                MessageType           @default(TEXT)
  providerMessageId   String?
  textBody            String?
  mediaId             String?
  status              MessageStatus         @default(QUEUED)
  errorCode           String?
  errorMessage        String?
  sentAt              DateTime?
  receivedAt          DateTime?
  createdAt           DateTime              @default(now())
  AiActionMessageLink AiActionMessageLink[]
  MediaAsset          MediaAsset[]
  Conversation        Conversation          @relation(fields: [conversationId], references: [id])

  @@unique([storeId, providerMessageId])
  @@index([conversationId, createdAt])
}

model MigrationRun {
  id String @id @default(uuid())
  key         String          @unique
  description String?
  status      MigrationStatus @default(PENDING)
  progress    Int             @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  lastError   String?
  metadata    Json?

  @@index([status, startedAt])
}

model NotificationOutbox {
  id String @id @default(uuid())
  storeId           String
  channel           String
  templateKey       String?
  to                String
  payload           Json?
  status            String   @default("QUEUED")
  providerMessageId String?
  errorCode         String?
  errorMessage      String?
  recipientId       String?
  orderId           String?
  ticketId          String?
  createdAt         DateTime @default(now())
  updatedAt DateTime @updatedAt
  store             Store    @relation(fields: [storeId], references: [id])

  @@index([storeId, status])
}

model NotificationTemplate {
  id String @id @default(uuid())
  storeId   String
  channel   String
  key       String
  name      String
  enabled   Boolean  @default(true)
  subject   String?
  body      String
  variables Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  store     Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, channel, key])
}

model OnboardingFlow {
  id String @id @default(uuid())
  storeId        String           @unique
  status         OnboardingStatus @default(IN_PROGRESS)
  currentStepKey String?
  completedSteps String[]
  skippedSteps   String[]
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt
}

model OpsSession {
  id String @id @default(uuid())
  opsUserId String
  token     String   @unique
  device    String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  OpsUser   OpsUser  @relation(fields: [opsUserId], references: [id])
}

model OpsUser {
  id String @id @default(uuid())
  email        String       @unique
  password     String
  name         String
  role         String
  mfaSecret    String?
  isMfaEnabled Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt DateTime @updatedAt
  OpsSession   OpsSession[]
}

model Order {
  id String @id @default(uuid())
  refCode            String               @unique
  storeId            String
  customerId         String?
  customerEmail      String?
  customerPhone      String?
  orderNumber        Int                  @default(autoincrement())
  source             String               @default("CHECKOUT")
  status             OrderStatus          @default(DRAFT)
  paymentStatus      PaymentStatus        @default(INITIATED)
  fulfillmentStatus  FulfillmentStatus    @default(UNFULFILLED)
  deliveryMethod     String?
  deliveryFee        Decimal              @default(0) @db.Decimal(10, 2)
  paymentMethod      String?
  internalNote       String?
  customerNote       String?
  currency           String               @default("NGN")
  subtotal           Decimal              @db.Decimal(10, 2)
  tax                Decimal              @default(0) @db.Decimal(10, 2)
  shippingTotal      Decimal              @default(0) @db.Decimal(10, 2)
  discountTotal      Decimal              @default(0) @db.Decimal(10, 2)
  total              Decimal              @db.Decimal(10, 2)
  channel            Channel              @default(STOREFRONT)
  createdAt          DateTime             @default(now())
  updatedAt DateTime @updatedAt
  Customer           Customer?            @relation(fields: [customerId], references: [id])
  store              Store                @relation(fields: [storeId], references: [id])
  OrderEvent         OrderEvent[]
  OrderItem          OrderItem[]
  OrderTimelineEvent OrderTimelineEvent[]
  PaymentIntent      PaymentIntent[]
  PaymentTransaction PaymentTransaction[]
  Receipt            Receipt[]
  Shipment           Shipment?
  supportTickets     SupportTicket[]
  disputes           Dispute[]

  @@index([storeId, createdAt])
  @@index([storeId, fulfillmentStatus])
  @@index([storeId, paymentStatus])
  @@index([storeId, status])
}

model OrderDiscount {
  id String @id @default(uuid())
  storeId                String
  orderId                String
  ruleId                 String
  couponCode             String?
  discountAmount         Decimal  @db.Decimal(10, 2)
  shippingDiscountAmount Decimal  @default(0) @db.Decimal(10, 2)
  metadata               Json?
  createdAt              DateTime @default(now())

  @@unique([orderId, ruleId])
}

model OrderEvent {
  id String @id @default(uuid())
  storeId   String
  orderId   String
  type      String
  message   String
  metadata  Json?
  createdBy String?
  createdAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])
}

model OrderItem {
  id String @id @default(uuid())
  orderId        String
  productId      String?
  variantId      String?
  title          String
  sku            String?
  price          Decimal         @db.Decimal(10, 2)
  quantity       Int
  Order          Order           @relation(fields: [orderId], references: [id])
  ProductVariant ProductVariant? @relation(fields: [variantId], references: [id])
}

model OrderTimelineEvent {
  id String @id @default(uuid())
  orderId   String
  title     String
  body      String?
  createdAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id])
}

model OtpCode {
  id String @id @default(uuid())
  identifier String
  code       String
  type       String
  expiresAt  DateTime
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([identifier, type])
}

model OutboxEvent {
  id String @id @default(uuid())
  storeId     String?
  type        String
  payload     Json
  status      OutboxEventStatus @default(PENDING)
  nextRetryAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, nextRetryAt])
  @@index([storeId, type])
}

model PaymentAccount {
  id String @id @default(uuid())
  storeId           String
  provider          String
  providerAccountId String
  status            String   @default("DISCONNECTED")
  defaultCurrency   String   @default("NGN")
  capabilities      Json?
  webhookSecretEnc  String?
  createdAt         DateTime @default(now())
  updatedAt DateTime @updatedAt
  store             Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, provider])
}

model PaymentCustomer {
  id String @id @default(uuid())
  storeId            String
  contactId          String?
  provider           String
  providerCustomerId String
  email              String?
  phoneE164          String?
  createdAt          DateTime @default(now())
  updatedAt DateTime @updatedAt
  store              Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, provider, providerCustomerId])
  @@index([storeId, email])
}

model PaymentIntent {
  id String @id @default(uuid())
  storeId                 String
  orderId                 String?
  provider                String
  providerPaymentIntentId String
  status                  String
  amount                  Decimal  @db.Decimal(10, 2)
  currency                String
  clientSecretHash        String?
  description             String?
  metadata                Json?
  createdAt               DateTime @default(now())
  updatedAt DateTime @updatedAt
  Charge                  Charge[]
  Order                   Order?   @relation(fields: [orderId], references: [id])
  store                   Store    @relation(fields: [storeId], references: [id])

  @@unique([provider, providerPaymentIntentId])
  @@index([storeId, status, createdAt(sort: Desc)])
}

model PaymentTransaction {
  id String @id @default(uuid())
  storeId   String
  orderId   String
  reference String        @unique
  provider  String
  amount    Decimal       @db.Decimal(10, 2)
  currency  String
  status    PaymentStatus
  type      String
  metadata  Json?
  createdAt DateTime      @default(now())
  Order     Order         @relation(fields: [orderId], references: [id])
  store     Store         @relation(fields: [storeId], references: [id])

  @@index([storeId, reference])
}

model PaymentWebhookEvent {
  id String @id @default(uuid())
  storeId         String?
  provider        String
  providerEventId String
  eventType       String
  payload         Json
  status          String    @default("RECEIVED")
  error           String?
  receivedAt      DateTime  @default(now())
  processedAt     DateTime?

  @@unique([provider, providerEventId])
}

model Payout {
  id String @id @default(uuid())
  storeId          String
  provider         String
  providerPayoutId String
  status           String
  amount           Decimal   @db.Decimal(10, 2)
  currency         String
  arrivalDate      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt DateTime @updatedAt
  store            Store     @relation(fields: [storeId], references: [id])

  @@unique([provider, providerPayoutId])
}

model Permission {
  id String @id @default(uuid())
  key            String           @unique
  description    String?
  group          String
  RolePermission RolePermission[]
}

model Plan {
  id String @id @default(uuid())
  key          String   @unique
  name         String
  description  String?
  currency     String   @default("NGN")
  priceMonthly Decimal  @db.Decimal(10, 2)
  priceYearly  Decimal  @db.Decimal(10, 2)
  features     Json
  limits       Json
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model PlatformKillSwitch {
  id String @id @default(uuid())
  key       String   @unique
  enabled   Boolean  @default(false)
  config    Json?
  reason    String?
  updatedAt DateTime @updatedAt
}

model Product {
  id String @id @default(uuid())
  storeId            String
  title              String
  description        String?
  handle             String
  status             String              @default("DRAFT")
  productType        String?
  brand              String?
  tags               String[]
  price              Decimal             @default(0) @db.Decimal(10, 2)
  compareAtPrice     Decimal?            @db.Decimal(10, 2)
  costPrice          Decimal?            @db.Decimal(10, 2)
  sku                String?
  barcode            String?
  trackInventory     Boolean             @default(true)
  allowBackorder     Boolean             @default(false)
  weight             Float?
  width              Float?
  height             Float?
  depth              Float?
  seoTitle           String?
  seoDescription     String?
  createdAt          DateTime            @default(now())
  updatedAt DateTime @updatedAt
  CollectionProduct  CollectionProduct[]
  InventoryItem      InventoryItem[]
  MarketplaceListing MarketplaceListing?
  store              Store               @relation(fields: [storeId], references: [id])
  ProductImage       ProductImage[]
  ProductVariant     ProductVariant[]

  @@unique([storeId, handle])
  @@index([storeId, status])
}

model ProductImage {
  id String @id @default(uuid())
  productId      String
  url            String
  altText        String?
  width          Int?
  height         Int?
  s3Key          String?
  position       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt
  Product        Product          @relation(fields: [productId], references: [id])
  ProductVariant ProductVariant[]
}

model ProductVariant {
  id String @id @default(uuid())
  productId      String
  title          String
  options        Json
  sku            String?
  barcode        String?
  price          Decimal?         @db.Decimal(10, 2)
  compareAtPrice Decimal?         @db.Decimal(10, 2)
  costPrice      Decimal?         @db.Decimal(10, 2)
  trackInventory Boolean          @default(true)
  allowBackorder Boolean          @default(false)
  weight         Float?
  position       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt
  imageId        String?
  InventoryEvent InventoryEvent[]
  InventoryItem  InventoryItem[]
  OrderItem      OrderItem[]
  ProductImage   ProductImage?    @relation(fields: [imageId], references: [id])
  Product        Product          @relation(fields: [productId], references: [id])
}

model Receipt {
  id String @id @default(uuid())
  orderId   String
  url       String
  createdAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id])
}

model Refund {
  id String @id @default(uuid())
  storeId           String
  orderId           String?
  chargeId          String
  provider          String
  providerRefundId  String?
  status            String            @default("PENDING")
  amount            Decimal           @db.Decimal(10, 2)
  currency          String
  reason            String?
  requestedBy       String?
  approvedBy        String?
  approvedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt DateTime @updatedAt
  approvalRequestId String?           @unique
  approvalRequest   Approval?         @relation(fields: [approvalRequestId], references: [id])
  Charge            Charge            @relation(fields: [chargeId], references: [id])
  store             Store             @relation(fields: [storeId], references: [id])

  @@unique([provider, providerRefundId])
}

model Report {
  id String @id @default(uuid())
  entityType         ReportEntityType
  entityId           String
  reporterIp         String?
  reporterCustomerId String?
  reason             ReportReason
  details            String?
  status             ReportStatus     @default(OPEN)
  createdAt          DateTime         @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([status, createdAt])
}

model ReturnItem {
  id String @id @default(uuid())
  returnRequestId   String
  orderItemId       String?
  qty               Int
  conditionReceived ReturnCondition?
  restockAction     RestockAction?
  createdAt         DateTime         @default(now())
}

model ReturnLogistics {
  id String @id @default(uuid())
  returnRequestId     String       @unique
  method              ReturnMethod
  pickupAddress       Json?
  dropoffInstructions String?
  carrierJobId        String?
  status              String       @default("PENDING")
  createdAt           DateTime     @default(now())
  updatedAt DateTime @updatedAt
}

model ReturnRequest {
  id String @id @default(uuid())
  merchantId     String
  orderId        String
  customerId     String?
  status         ReturnStatus     @default(REQUESTED)
  reasonCode     ReturnReason
  reasonText     String?
  resolutionType ReturnResolution
  requestedAt    DateTime         @default(now())
  approvedAt     DateTime?
  completedAt    DateTime?
  createdBy      String           @default("CUSTOMER")
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId, status])
}

model Review {
  id String @id @default(uuid())
  storeId            String
  storeProfileId     String
  productId          String?
  orderId            String?
  customerId         String?
  rating             Int
  title              String?
  body               String?
  status             ReviewStatus @default(PENDING)
  isVerifiedPurchase Boolean      @default(false)
  createdAt          DateTime     @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, status, createdAt])
  @@index([storeProfileId, status, createdAt])
}

model ReviewMedia {
  id String @id @default(uuid())
  reviewId  String
  s3Key     String
  url       String
  createdAt DateTime @default(now())
}

model RiskProfile {
  id                String     @id @default(uuid())
  merchantId        String     @unique
  merchantRiskScore Int        @default(0)
  status            RiskStatus @default(LOW)
  lastEvaluatedAt   DateTime?
  metadata          Json?
  updatedAt         DateTime   @updatedAt
  store             Store      @relation(fields: [merchantId], references: [id])

  @@map("risk_profile")
}

model RiskSignal {
  id String @id @default(uuid())
  merchantId String?
  scope      RiskScope
  scopeId    String?
  key        String
  severity   RiskSeverity
  scoreDelta Int
  metadata   Json?
  createdAt  DateTime     @default(now())

  @@index([merchantId, scope, key])
}

model Role {
  id String @id @default(uuid())
  storeId        String?
  name           String
  description    String?
  isSystem       Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt DateTime @updatedAt
  Membership     Membership[]
  store          Store?           @relation(fields: [storeId], references: [id])
  RolePermission RolePermission[]

  @@unique([storeId, name])
}

model RolePermission {
  id String @id @default(uuid())
  roleId       String
  permissionId String
  Permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  Role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model SecuritySetting {
  id String @id @default(uuid())
  storeId               String   @unique
  mfaRequired           Boolean  @default(false)
  sessionTimeoutMinutes Int      @default(720)
  allowedIpRanges       String[]
  updatedAt DateTime @updatedAt
  store                 Store    @relation(fields: [storeId], references: [id])
}

model Segment {
  id String @id @default(uuid())
  storeId       String
  name          String
  definition    Json
  estimatedSize Int?
  createdAt     DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
}

model Shipment {
  id String @id @default(uuid())
  storeId            String
  orderId            String          @unique
  deliveryOptionType String
  status             String          @default("PENDING")
  recipientName      String?
  recipientPhone     String?
  addressState       String?
  addressCity        String?
  addressLga         String?
  addressLine1       String?
  addressLine2       String?
  landmark           String?
  lat                Float?
  lng                Float?
  deliveryFee        Decimal         @default(0) @db.Decimal(10, 2)
  currency           String          @default("NGN")
  trackingUrl        String?
  trackingCode       String?
  createdAt          DateTime        @default(now())
  updatedAt DateTime @updatedAt
  DispatchJob        DispatchJob[]
  Order              Order           @relation(fields: [orderId], references: [id])
  store              Store           @relation(fields: [storeId], references: [id])
  TrackingEvent      TrackingEvent[]
}

model StaffInvite {
  id String @id @default(uuid())
  storeId    String
  email      String
  phone      String?
  role       String    @default("viewer")
  token      String    @unique
  createdBy  String
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt DateTime @updatedAt
  store      Store     @relation(fields: [storeId], references: [id])

  @@unique([storeId, email])
}

model Store {
  id                       String                    @id @default(uuid())
  name                     String
  slug                     String                    @unique
  logoUrl                  String?
  onboardingStatus         OnboardingStatus          @default(NOT_STARTED)
  onboardingLastStep       String?                   @default("START")
  onboardingUpdatedAt      DateTime                  @default(now())
  onboardingCompleted      Boolean                   @default(false)
  plan                     SubscriptionPlan          @default(STARTER)
  category                 String                    @default("general")
  contacts                 Json?                     @default("{}")
  settings                 Json?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  tenantId                 String?
  isLive                   Boolean                   @default(false)
  liveAt                   DateTime?
  unpublishedAt            DateTime?
  aiActionRuns             AiActionRun[]
  bankBeneficiaries        BankBeneficiary[]
  carrierAccounts          CarrierAccount[]
  charges                  Charge[]
  collections              Collection[]
  contactsList             Contact[]
  conversations            Conversation[]
  customers                Customer[]
  customerAddresses        CustomerAddress[]
  deliveryOptions          DeliveryOption[]
  deliveryProfiles         DeliveryProfile[]
  deliveryZones            DeliveryZone[]
  dispatchJobs             DispatchJob[]
  inventoryLocations       InventoryLocation[]
  inventoryMovements       InventoryMovement[]
  invoicesV2               InvoiceV2[]
  knowledgeBaseEntries     KnowledgeBaseEntry[]
  kycRecord                KycRecord?
  ledgerEntries            LedgerEntry[]
  memberships              Membership[]
  merchantOnboarding       MerchantOnboarding?
  merchantPolicies         MerchantPolicy[]
  notificationOutboxes     NotificationOutbox[]
  notificationTemplates    NotificationTemplate[]
  orders                   Order[]
  orderEvents              OrderEvent[]
  paymentAccounts          PaymentAccount[]
  paymentCustomers         PaymentCustomer[]
  paymentIntents           PaymentIntent[]
  paymentTransactions      PaymentTransaction[]
  payouts                  Payout[]
  products                 Product[]
  refunds                  Refund[]
  roles                    Role[]
  securitySetting          SecuritySetting?
  shipments                Shipment[]
  staffInvites             StaffInvite[]
  tenant                   Tenant?                   @relation(fields: [tenantId], references: [id])
  wallet                   Wallet?
  whatsAppChannel          WhatsappChannel?
  withdrawal               Withdrawal[]
  domainMapping            DomainMapping[]
  dunningAttempt           DunningAttempt[]
  importJob                ImportJob[]
  invoice                  Invoice[]
  merchantSubscription     MerchantSubscription?
  notification             Notification[]
  notificationPreference   NotificationPreference?
  publishHistory           PublishHistory[]
  storeTemplateSelection   StoreTemplateSelection?
  supportTickets           SupportTicket[]
  ticketMessages           TicketMessage[]
  webhookEvents            WebhookEvent[]
  riskProfile              RiskProfile?
  disputes                 Dispute[]
}

model StoreProfile {
  id String @id @default(uuid())
  storeId             String   @unique
  slug                String   @unique
  displayName         String
  bio                 String?
  logoUrl             String?
  bannerUrl           String?
  state               String?
  city                String?
  lga                 String?
  categories          String[]
  whatsappNumberE164  String?
  websiteUrl          String?
  isDirectoryListed   Boolean  @default(false)
  isMarketplaceListed Boolean  @default(false)
  pickupAvailable     Boolean  @default(false)
  deliveryMethods     String[] @default(["self_dispatch"])
  createdAt           DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isDirectoryListed, state, city])
  @@index([slug])
}

model StorefrontSettings {
  id String @id @default(uuid())
  storeId        String   @unique
  slug           String   @unique
  isLive         Boolean  @default(false)
  themeKey       String   @default("vayva_light_glass_store_v1")
  accentColor    String?  @default("#22C55E")
  logoS3Key      String?
  bannerS3Key    String?
  socialLinks    Json?
  seoTitle       String?
  seoDescription String?
  updatedAt DateTime @updatedAt
}

model Subscription {
  id String @id @default(uuid())
  storeId                String             @unique
  planKey                String
  status                 SubscriptionStatus @default(TRIALING)
  provider               BillingProvider    @default(STRIPE)
  providerSubscriptionId String?
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean            @default(false)
  trialEndsAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt DateTime @updatedAt
  InvoiceV2              InvoiceV2[]
  invoice                Invoice[]

  @@index([storeId, status])
}

model SupportCase {
  id String @id @default(uuid())
  storeId          String
  createdByAdminId String
  category         SupportCaseCategory
  summary          String
  status           SupportCaseStatus   @default(OPEN)
  links            Json?
  createdAt        DateTime            @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([storeId, status])
}

model Template {
  id String @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  category    String   @default("General")
  tags        String[]
  licenseKey  String?
  licenseName String?
  repoUrl     String?
  homepageUrl String?
  stars       Int      @default(0)
  isActive    Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  isFree      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TemplateAsset {
  id String @id @default(uuid())
  templateId String
  type       String
  storageKey String
  publicUrl  String?
  createdAt  DateTime @default(now())
}

model TemplateSource {
  id String @id @default(uuid())
  name          String
  provider      String   @default("github")
  queryText     String?
  enabled       Boolean  @default(true)
  allowLicenses String[]
  minStars      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TemplateSyncRun {
  id String @id @default(uuid())
  sourceId      String?
  status        String
  importedCount Int       @default(0)
  rejectedCount Int       @default(0)
  errorText     String?
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
}

model TemplateVersion {
  id String @id @default(uuid())
  templateId     String
  version        String
  commitSha      String?
  packStorageKey String?
  createdAt      DateTime @default(now())
}

model Tenant {
  id String @id @default(uuid())
  name             String
  slug             String             @unique
  createdAt        DateTime           @default(now())
  updatedAt DateTime @updatedAt
  store            Store[]
  TenantMembership TenantMembership[]
}

model TenantMembership {
  id String @id @default(uuid())
  tenantId String
  userId   String
  role     AppRole @default(OWNER)
  Tenant   Tenant  @relation(fields: [tenantId], references: [id])
  User     User    @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId])
}

model TrackingEvent {
  id String @id @default(uuid())
  storeId       String
  shipmentId    String
  dispatchJobId String?
  status        String
  description   String
  locationText  String?
  occurredAt    DateTime @default(now())
  raw           Json?
  createdAt     DateTime @default(now())
  Shipment      Shipment @relation(fields: [shipmentId], references: [id])
}

model TrustBadgeSnapshot {
  id String @id @default(uuid())
  storeId   String
  date      DateTime @db.Date
  badges    String[]
  metrics   Json
  createdAt DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId, date])
}

model UsageCounter {
  id String @id @default(uuid())
  storeId     String
  key         String
  periodStart DateTime
  periodEnd   DateTime
  used        Int      @default(0)
  limit       Int
  updatedAt DateTime @updatedAt

  @@unique([storeId, key, periodStart])
  @@index([storeId, key])
}

model User {
  id               String             @id @default(uuid())
  email            String             @unique
  password         String
  firstName        String?
  lastName         String?
  phone            String?
  avatarUrl        String?
  isEmailVerified  Boolean            @default(false)
  isPhoneVerified  Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  memberships      Membership[]
  merchantSessions MerchantSession[]
  tenantMemberships TenantMembership[]
}

model Wallet {
  id String @id @default(uuid())
  storeId              String               @unique
  kycStatus            KycStatus            @default(NOT_STARTED)
  pinHash              String?
  pinSet               Boolean              @default(false)
  isLocked             Boolean              @default(false)
  failedPinAttempts    Int                  @default(0)
  lockedUntil          DateTime?
  availableKobo        BigInt               @default(0)
  pendingKobo          BigInt               @default(0)
  vaStatus             VirtualAccountStatus @default(NOT_CREATED)
  vaBankName           String?
  vaAccountNumber      String?
  vaAccountName        String?
  vaProviderRef        String?
  createdAt            DateTime             @default(now())
  updatedAt DateTime @updatedAt
  twoFactorSecret      String?
  twoFactorEnabled     Boolean              @default(false)
  twoFactorBackupCodes String[]             @default([])
  store                Store                @relation(fields: [storeId], references: [id])
}

model WebhookDelivery {
  id String @id @default(uuid())
  storeId             String
  endpointId          String
  eventId             String
  eventType           String
  attempt             Int                   @default(1)
  status              WebhookDeliveryStatus @default(PENDING)
  responseCode        Int?
  responseBodySnippet String?
  nextRetryAt         DateTime?
  deliveredAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt DateTime @updatedAt

  @@index([endpointId, createdAt])
  @@index([storeId, status, nextRetryAt])
}

model WebhookEndpoint {
  id String @id @default(uuid())
  storeId          String
  url              String
  status           WebhookEndpointStatus @default(ACTIVE)
  secretEnc        String
  subscribedEvents String[]
  createdAt        DateTime              @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, status])
}

model WebhookEventV2 {
  id String @id @default(uuid())
  storeId   String
  type      String
  payload   Json
  createdAt DateTime @default(now())

  @@index([storeId, type, createdAt])
}

model WhatsappChannel {
  id String @id @default(uuid())
  storeId            String              @unique
  provider           String              @default("meta")
  wabaId             String?
  phoneNumberId      String?
  displayPhoneNumber String?
  businessName       String?
  status             String              @default("DISCONNECTED")
  createdAt          DateTime            @default(now())
  updatedAt DateTime @updatedAt
  store              Store               @relation(fields: [storeId], references: [id])
  WhatsappCredential WhatsappCredential?
}

model WhatsappCredential {
  id String @id @default(uuid())
  channelId       String          @unique
  encryptedToken  String
  tokenExpiresAt  DateTime?
  createdAt       DateTime        @default(now())
  updatedAt DateTime @updatedAt
  WhatsappChannel WhatsappChannel @relation(fields: [channelId], references: [id])
}

model WhatsappTemplate {
  id String @id @default(uuid())
  storeId    String
  name       String
  language   String
  category   String
  status     String
  components Json
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, name, language])
}

model Withdrawal {
  id            String    @id @default(uuid())
  storeId       String
  amountKobo    BigInt
  feeKobo       BigInt    @default(0)
  bankAccountId String
  status        String
  otpCode       String?
  otpExpiresAt  DateTime?
  providerRef   String?
  createdAt     DateTime  @default(now())
  updatedAt DateTime @updatedAt
  store         Store     @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model analytics_event {
  id String @id @default(uuid())
  merchantId    String
  storeId       String?
  eventName     String
  occurredAt    DateTime @default(now())
  visitorId     String?
  sessionId     String?
  referrer      String?
  path          String?
  properties    Json?    @default("{}")
  correlationId String
  createdAt     DateTime @default(now())

  @@index([merchantId, eventName, occurredAt(sort: Desc)])
  @@index([merchantId, occurredAt(sort: Desc)])
  @@index([storeId, occurredAt(sort: Desc)])
}

model LegacyApiKey {
  id String @id @default(uuid())
  merchantId      String
  name            String
  keyHash         String    @unique
  prefix          String
  scopes          String[]
  status          String    @default("active")
  lastUsedAt      DateTime?
  createdByUserId String
  createdAt       DateTime  @default(now())
  revokedAt       DateTime?

  @@index([merchantId])

  @@map("api_key")
}

model ApprovalExecutionLog {
  id                String    @id @default(uuid())
  approvalRequestId String
  status            String
  output            Json?
  error             String?
  startedAt         DateTime  @default(now())
  finishedAt        DateTime?

  @@map("approval_execution_log")
}

model Approval {
  id                String         @id @default(uuid())
  merchantId        String
  storeId           String?
  requestedByUserId String?
  requestedByLabel  String?
  actionType        String?
  type              String?
  summary           String?
  entityType        String?
  entityId          String?
  payload           Json?
  data              Json?
  status            ApprovalStatus @default(PENDING)
  actionBy          String?
  reason            String?
  decisionReason    String?
  decidedByUserId   String?
  decidedByLabel    String?
  decidedAt         DateTime?
  executionId       String?
  correlationId     String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  Refund            Refund?

  @@index([executionId])
  @@index([merchantId, status])

  @@map("approval_request")
}

model AuditLog {
  id            String   @id @default(uuid())
  storeId       String?
  actorType     String
  actorId       String?
  actorLabel    String
  action        String
  entityType    String?
  entityId      String?
  beforeState   Json?
  afterState    Json?
  ipAddress     String?
  userAgent     String?
  correlationId String
  createdAt     DateTime @default(now())

  @@index([correlationId])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@index([storeId, createdAt(sort: Desc)])

  @@map("audit_log")
}

model BackupReceipt {
  id String @id @default(uuid())
  provider   String
  backupType String
  backupId   String
  status     String
  createdAt  DateTime @default(now())
  meta       Json?    @default("{}")

  @@map("backup_receipt")
}

model checkout_recovery_message {
  id String @id @default(uuid())
  checkoutSessionId String
  channel           String
  stage             String
  status            String    @default("scheduled")
  scheduledAt       DateTime
  sentAt            DateTime?
  error             String?

  @@unique([checkoutSessionId, stage, channel])
}

model checkout_recovery_settings {
  merchantId      String   @id
  enabled         Boolean  @default(false)
  stage1Hours     Int      @default(1)
  stage2Hours     Int      @default(24)
  channelPriority String   @default("whatsapp_then_email")
  updatedAt DateTime @updatedAt @default(now())
}

model checkout_session {
  id String @id @default(uuid())
  storeId         String
  merchantId      String
  orderDraftId    String   @unique
  status          String   @default("active")
  customerPhone   String?
  customerEmail   String?
  cart            Json
  amount          Int
  currency        String   @default("NGN")
  idempotencyKey  String   @unique
  resumeTokenHash String   @unique
  resumeExpiresAt DateTime
  lastActivityAt  DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([merchantId])
  @@index([storeId])
}

model communication_consent {
  id String @id @default(uuid())
  merchantId           String
  customerId           String?
  phoneE164            String?
  marketingOptIn       Boolean   @default(false)
  marketingOptInSource String    @default("unknown")
  marketingOptInAt     DateTime?
  marketingOptOutAt    DateTime?
  transactionalAllowed Boolean   @default(true)
  fullyBlocked         Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@index([phoneE164])
}

model compliance_event {
  id String @id @default(uuid())
  merchantId String
  customerId String?
  phoneE164  String?
  eventType  ConsentEventType
  channel    ConsentChannel
  source     ConsentSource
  metadata   Json             @default("{}")
  createdAt  DateTime         @default(now())

  @@index([phoneE164])
}

model conversation_tag {
  id String @id @default(uuid())
  merchantId           String
  name                 String
  color                String?
  createdAt            DateTime               @default(now())
  conversation_tag_map conversation_tag_map[]

  @@unique([merchantId, name])
}

model conversation_tag_map {
  conversationId   String
  tagId            String
  Conversation     Conversation     @relation(fields: [conversationId], references: [id])
  conversation_tag conversation_tag @relation(fields: [tagId], references: [id])

  @@id([conversationId, tagId])
  @@index([conversationId])
  @@index([tagId])
}





model DisputeSubmission {
  id                String   @id @default(uuid())
  disputeId         String   @unique
  submittedBy       String
  submittedAt       DateTime @default(now())
  providerReference String?
  notes             String?

  @@map("dispute_submission")
}

model DomainMapping {
  id                String   @id @default(uuid())
  storeId           String
  domain            String   @unique
  status            String   @default("pending")
  verificationToken String
  provider          Json?    @default("{}")
  createdAt         DateTime @default(now())
  store             Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])

  @@map("domain_mapping")
}

model DunningAttempt {
  id             String    @id @default(uuid())
  storeId        String
  subscriptionId String
  attemptNumber  Int
  status         String
  nextAttemptAt  DateTime?
  lastError      String?
  createdAt      DateTime  @default(now())
  store          Store     @relation(fields: [storeId], references: [id])

  @@index([storeId])

  @@map("dunning_attempt")
}

model email_message {
  id String @id @default(uuid())
  merchantId    String?
  userId        String?
  toEmail       String
  subject       String
  templateKey   String?
  status        String
  provider      String?
  providerMsgId String?
  error         String?
  meta          Json     @default("{}")
  correlationId String?
  createdAt     DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model email_suppression {
  id String @id @default(uuid())
  email     String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  description String
  enabled     Boolean  @default(false)
  rules       Json     @default("{}")
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@map("feature_flag")
}

model fraud_signal {
  id String @id @default(uuid())
  storeId       String
  merchantId    String
  type          String
  severity      String   @default("low")
  metadata      Json?    @default("{}")
  correlationId String
  createdAt     DateTime @default(now())
}

model idempotency_key {
  id String @id @default(uuid())
  merchantId  String?
  key         String   @unique
  scope       String
  requestHash String
  status      String   @default("started")
  response    Json?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([merchantId, scope])
}

model ImportJob {
  id               String   @id @default(uuid())
  merchantId       String
  type             String   @default("products_csv")
  status           String   @default("pending")
  originalFilename String
  fileUrl          String
  checksum         String
  totalRows        Int      @default(0)
  validRows        Int      @default(0)
  invalidRows      Int      @default(0)
  processedRows    Int      @default(0)
  errorReportUrl   String?
  summary          Json?
  mappings         Json?
  correlationId    String
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt DateTime @updatedAt
  store            Store    @relation(fields: [merchantId], references: [id])

  @@unique([merchantId, checksum, type])
  @@index([merchantId, status])

  @@map("import_job")
}

model incident {
  id String @id @default(uuid())
  title            String
  description      String?
  status           String
  severity         String
  affectedServices Json
  createdAt        DateTime  @default(now())
  resolvedAt       DateTime?
}

model incident_link {
  id String @id @default(uuid())
  incidentId    String
  uptimeCheckId String

  @@index([incidentId])
  @@index([uptimeCheckId])
}

model InternalNote {
  id             String       @id @default(uuid())
  merchantId     String
  conversationId String
  authorId       String
  note           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  Conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])

  @@map("internal_note")
}

model inventory_item {
  id String @id @default(uuid())
  merchantId        String
  storeId           String?
  productId         String
  variantId         String?
  onHand            Int      @default(0)
  reserved          Int      @default(0)
  lowStockThreshold Int      @default(3)
  updatedAt DateTime @updatedAt @default(now())

  @@unique([merchantId, productId, variantId])
  @@index([merchantId])
  @@index([productId])
}

model Invoice {
  id                 String        @id @default(uuid())
  storeId            String
  invoiceNumber      String        @unique
  amountNgn          Int
  currency           String        @default("NGN")
  status             String        @default("pending")
  providerInvoiceRef String?
  issuedAt           DateTime      @default(now())
  paidAt             DateTime?
  pdfUrl             String?
  metadata           Json?         @default("{}")
  createdAt          DateTime      @default(now())
  subscriptionId     String?
  store              Store         @relation(fields: [storeId], references: [id])
  Subscription       Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([storeId])

  @@map("invoice")
}

model job_dead_letter {
  id String @id @default(uuid())
  jobId         String?
  type          String
  payload       Json
  error         String?
  attempts      Int      @default(0)
  lastAttemptAt DateTime @default(now())
  createdAt     DateTime @default(now())
}

model MerchantAccountLifecycle {
  merchantId          String    @id
  status              String    @default("active")
  deletionRequestedAt DateTime?
  deletedAt           DateTime?
  deletionReason      String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("merchant_account_lifecycle")
}

model MerchantSecuritySettings {
  merchantId               String   @id
  requireEmailVerification Boolean  @default(true)
  require2FA               Boolean  @default(false)
  sessionTimeoutDays       Int      @default(30)
  updatedAt                DateTime @default(now()) @updatedAt

  @@map("merchant_security_settings")
}

model MerchantSubscription {
  id                     String    @id @default(uuid())
  storeId                String    @unique
  planSlug               String
  status                 String    @default("trial")
  provider               String    @default("paystack")
  providerCustomerId     String?
  providerSubscriptionId String?
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean   @default(false)
  cancelledAt            DateTime?
  lastPaymentStatus      String?
  lastPaymentAt          DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  store                  Store     @relation(fields: [storeId], references: [id])

  @@map("merchant_subscription")
}

model Notification {
  id         String    @id @default(uuid())
  storeId    String
  userId     String?
  type       String
  title      String
  body       String
  severity   String
  actionUrl  String?
  entityType String?
  entityId   String?
  metadata   Json      @default("{}")
  category   String    @default("system")
  channels   Json      @default("[\"in_app\"]")
  dedupeKey  String?   @unique
  isRead     Boolean   @default(false)
  readAt     DateTime?
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())
  store      Store     @relation(fields: [storeId], references: [id])

  @@index([storeId, createdAt(sort: Desc)])
  @@index([storeId, isRead, createdAt(sort: Desc)])
  @@index([storeId, userId, createdAt(sort: Desc)])

  @@map("notification")
}

model NotificationPreference {
  id         String   @id @default(uuid())
  storeId    String   @unique
  channels   Json     @default("{\"email\": true, \"banner\": true, \"in_app\": true, \"whatsapp\": false}")
  categories Json     @default("{\"orders\": true, \"system\": true, \"account\": true, \"payments\": true}")
  quietHours Json     @default("{\"end\": \"08:00\", \"start\": \"22:00\", \"enabled\": false}")
  updatedAt  DateTime @updatedAt
  store      Store    @relation(fields: [storeId], references: [id])

  @@map("notification_preference")
}

model Partner {
  id                   String                @id @default(uuid())
  name                 String
  type                 String
  status               String                @default("active")
  payoutMethod         Json?                 @default("{}")
  createdAt            DateTime              @default(now())
  partnerPayoutLedgers PartnerPayoutLedger[]
  partnerReferralCodes PartnerReferralCode[]
  referralAttributions ReferralAttribution[]

  @@map("partner")
}

model PartnerPayoutLedger {
  id         String    @id @default(uuid())
  partnerId  String
  merchantId String?
  amountNgn  Int
  reason     String
  status     String    @default("pending")
  createdAt  DateTime  @default(now())
  paidAt     DateTime?
  partner    Partner   @relation(fields: [partnerId], references: [id])

  @@index([partnerId])

  @@map("partner_payout_ledger")
}

model PartnerReferralCode {
  id        String   @id @default(uuid())
  partnerId String
  code      String   @unique
  codeHash  String   @unique
  createdAt DateTime @default(now())
  partner   Partner  @relation(fields: [partnerId], references: [id])

  @@map("partner_referral_code")
}


model password_reset_token {
  id String @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model PublishHistory {
  id            String   @id @default(uuid())
  storeId       String
  action        String
  actorType     String
  actorId       String?
  actorLabel    String
  correlationId String
  metadata      Json?    @default("{}")
  createdAt     DateTime @default(now())
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])

  @@map("publish_history")
}

model quick_reply {
  id String @id @default(uuid())
  merchantId String
  title      String
  content    String
  category   String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([merchantId, title])
}

model ReferralAttribution {
  id                String    @id @default(uuid())
  partnerId         String
  merchantId        String    @unique
  referralCode      String
  firstSeenAt       DateTime  @default(now())
  signupCompletedAt DateTime?
  storeLiveAt       DateTime?
  firstPaymentAt    DateTime?
  metadata          Json?     @default("{}")
  partner           Partner   @relation(fields: [partnerId], references: [id])

  @@map("referral_attribution")
}


model restore_drill_run {
  id String @id @default(uuid())
  startedAt     DateTime
  completedAt   DateTime?
  status        String
  restoreSource String
  error         String?
  meta          Json?     @default("{}")
}

model return_event {
  id String @id @default(uuid())
  returnRequestId String
  type            String
  metadata        Json?    @default("{}")
  actorType       String
  actorLabel      String
  createdAt       DateTime @default(now())

  @@index([returnRequestId])
}

model return_request {
  id String @id @default(uuid())
  merchantId        String
  storeId           String
  orderId           String
  customerPhone     String
  reason            String
  notes             String?
  items             Json
  status            String    @default("requested")
  decisionReason    String?
  decidedBy         String?
  decidedAt         DateTime?
  pickupMethod      String?
  pickupAddress     Json?
  dropoffAddress    Json?
  trackingRef       String?
  receivedAt        DateTime?
  inspectedAt       DateTime?
  inspectionOutcome String?
  refundId          String?
  correlationId     String
  createdAt         DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([storeId])
}

model StatusIncident {
  id          String    @id @default(uuid())
  title       String
  description String
  status      String
  impact      String
  startedAt   DateTime
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@map("status_incident")
}

model status_incident_update {
  id String @id @default(uuid())
  incidentId String
  message    String
  authorType String
  createdAt  DateTime @default(now())

  @@index([incidentId])
}

model status_incident_v2 {
  id String @id @default(uuid())
  title         String
  description   String?
  status        String    @default("investigating")
  impact        String
  startedAt     DateTime  @default(now())
  resolvedAt    DateTime?
  autoGenerated Boolean   @default(false)
  createdBy     String    @default("system")
  lastUpdateAt  DateTime?
  storeId       String?
}

model stock_movement {
  id String @id @default(uuid())
  merchantId     String
  productId      String
  variantId      String?
  type           String
  quantity       Int
  beforeOnHand   Int
  afterOnHand    Int
  beforeReserved Int
  afterReserved  Int
  referenceType  String?
  referenceId    String?
  actorType      String
  actorId        String?
  actorLabel     String
  correlationId  String
  createdAt      DateTime @default(now())

  @@index([merchantId])
  @@index([productId])
}

model stock_reservation {
  id String @id @default(uuid())
  merchantId   String
  orderDraftId String
  productId    String
  variantId    String?
  quantity     Int
  status       String   @default("active")
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([merchantId])
  @@index([orderDraftId])
}

model StoreTemplateSelection {
  id                 String            @id @default(uuid())
  storeId            String            @unique
  templateId         String
  version            String
  config             Json              @default("{}")
  previousTemplateId String?
  previousVersion    String?
  previousConfig     Json?
  appliedAt          DateTime          @default(now())
  appliedBy          String?
  store              Store             @relation(fields: [storeId], references: [id])
  templateManifest   TemplateManifest  @relation(fields: [templateId], references: [id])

  @@map("store_template_selection")
}

model SupportTicket {
  id             String           @id @default(uuid())
  storeId        String
  customerId     String?
  orderId        String?
  conversationId String?
  type           String
  status         String           @default("open")
  priority       String           @default("medium")
  subject        String
  description    String?
  metadata       Json             @default("{}")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Conversation   Conversation?    @relation(fields: [conversationId], references: [id])
  Customer       Customer?        @relation(fields: [customerId], references: [id])
  Order          Order?           @relation(fields: [orderId], references: [id])
  store          Store            @relation(fields: [storeId], references: [id])
  ticketMessages TicketMessage[]

  @@index([storeId])
  @@index([storeId, status])

  @@map("support_ticket")
}

model TemplateManifest {
  id                       String                     @id @default(uuid())
  name                     String
  description              String
  version                  String
  author                   String?
  source                   String
  homepageUrl              String?
  previewImageUrl          String
  tags                     String[]
  supportedPages           Json
  configSchema             Json                       @default("{}")
  isArchived               Boolean                    @default(false)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  storeTemplateSelections  StoreTemplateSelection[]

  @@map("template_manifest")
}

model TicketMessage {
  id             String         @id @default(uuid())
  ticketId       String
  storeId        String?
  sender         String
  senderId       String?
  message        String
  attachments    Json           @default("[]")
  createdAt      DateTime       @default(now())
  store          Store?         @relation(fields: [storeId], references: [id])
  supportTicket  SupportTicket  @relation(fields: [ticketId], references: [id])

  @@index([ticketId])

  @@map("ticket_message")
}

model UptimeCheck {
  id             String   @id @default(uuid())
  name           String
  url            String
  method         String   @default("GET")
  expectedStatus Int      @default(200)
  timeoutMs      Int      @default(5000)
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())

  @@map("uptime_check")
}

model uptime_check_result {
  id String @id @default(uuid())
  uptimeCheckId String
  status        String
  httpStatus    Int?
  latencyMs     Int?
  error         String?
  checkedAt     DateTime @default(now())

  @@index([uptimeCheckId, checkedAt(sort: Desc)])
}

model user_email_verification {
  id String @id @default(uuid())
  userId     String    @unique
  tokenHash  String    @unique
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
}

model UserSession {
  id               String    @id @default(uuid())
  userId           String
  sessionTokenHash String    @unique
  device           String?
  location         String?
  ipAddress        String?
  userAgent        String?
  lastSeenAt       DateTime  @default(now())
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  @@index([userId])

  @@map("user_session")
}

model webhook_delivery {
  id String @id @default(uuid())
  webhookSubscriptionId String
  merchantId            String
  eventName             String
  eventId               String
  attempt               Int       @default(1)
  status                String
  httpStatus            Int?
  error                 String?
  nextRetryAt           DateTime?
  deliveredAt           DateTime?
  createdAt             DateTime  @default(now())

  @@unique([webhookSubscriptionId, eventId])
  @@index([merchantId])
  @@index([webhookSubscriptionId])
}

model WebhookEvent {
  id          String    @id @default(uuid())
  merchantId  String?
  provider    String
  eventId     String    @unique
  eventType   String
  payload     Json
  status      String    @default("received")
  error       String?
  receivedAt  DateTime  @default(now())
  processedAt DateTime?
  store       Store?    @relation(fields: [merchantId], references: [id])

  @@index([provider, eventId])
  @@index([status])

  @@map("webhook_event")
}

model WebhookSubscription {
  id                String   @id @default(uuid())
  merchantId        String
  name              String
  url               String
  events            String[]
  signingSecretHash String
  status            String   @default("active")
  createdAt         DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())

  @@index([merchantId])

  @@map("webhook_subscription")
}

enum AiActionStatus {
  PROPOSED
  PENDING_APPROVAL
  RUNNING
  SUCCEEDED
  FAILED
  REJECTED
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
}

enum AppRole {
  OWNER
  ADMIN
  STAFF
  SUPPORT
  FINANCE
  OPS_ADMIN
  OPS_AGENT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum BillingProvider {
  STRIPE
  PAYSTACK
  MANUAL
}

enum CampaignChannel {
  WHATSAPP
  SMS
  EMAIL
}

enum CampaignSendStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
  SKIPPED
}

enum CampaignStatus {
  DRAFT
  PENDING_APPROVAL
  SCHEDULED
  SENDING
  PAUSED
  COMPLETED
  CANCELLED
  FAILED
}

enum CampaignType {
  BROADCAST
  AUTOMATION
}

enum Channel {
  STOREFRONT
  MARKETPLACE
  WHATSAPP
}

enum ChecklistCategory {
  STOREFRONT
  PAYMENTS
  DELIVERY
  WHATSAPP
  POLICIES
  SECURITY
}

enum ChecklistStatus {
  TODO
  DONE
  BLOCKED
  SKIPPED
}

enum ConsentChannel {
  WHATSAPP
  SMS
  EMAIL
}

enum ConsentEventType {
  OPT_IN
  OPT_OUT
  BLOCK_ALL
  UNBLOCK
  TRANSACTIONAL_ON
  TRANSACTIONAL_OFF
}

enum ConsentSource {
  CUSTOMER_ACTION
  MERCHANT_ACTION
  SYSTEM
}

enum ConsentStatus {
  OPT_IN
  OPT_OUT
}

enum ConsentType {
  MARKETING
  TRANSACTIONAL
}

enum CouponStatus {
  ACTIVE
  DISABLED
  EXPIRED
}

enum DLQStatus {
  DEAD
  REPLAYED
  IGNORED
}

enum DataRequestStatus {
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum DataRequestType {
  EXPORT
  DELETE
  ACCESS
  CORRECTION
}

enum DeliveryTaskStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

enum DeviceStatus {
  ACTIVE
  REVOKED
}

enum DeviceType {
  WEB_PUSH
  ANDROID
  IOS
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum DiscountAppliesTo {
  ALL
  PRODUCTS
  COLLECTIONS
}

enum DiscountType {
  PERCENT
  AMOUNT
  FREE_SHIPPING
}

enum DisputeEvidenceType {
  DELIVERY_PROOF
  CHAT_PROOF
  RECEIPT
  REFUND_POLICY
  INVOICE
  OTHER
}

enum DisputeProvider {
  STRIPE
  PAYSTACK
  OTHER
}

enum DisputeStatus {
  OPENED
  EVIDENCE_REQUIRED
  SUBMITTED
  UNDER_REVIEW
  WON
  LOST
  CANCELLED
}

enum EnforcementActionType {
  THROTTLE
  REQUIRE_MANUAL_APPROVAL
  DISABLE_CAMPAIGNS
  DISABLE_WHATSAPP_SENDING
  HOLD_REFUNDS
  SUSPEND
}

enum EnforcementScope {
  MERCHANT
  ORDER
  CAMPAIGN
  CUSTOMER
}

enum EvidenceFileType {
  SCREENSHOT
  PDF
  IMAGE
  JSON
  TEXT
}

enum EvidenceScope {
  ORDER
  RETURN
  DISPUTE
  REFUND
  DELIVERY
}

enum FlagSeverity {
  LOW
  MEDIUM
  HIGH
}

enum FulfillmentStatus {
  UNFULFILLED
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum IdempotencyStatus {
  STARTED
  COMPLETED
  FAILED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum JobRunStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum KycStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

enum LegalKey {
  PRIVACY
  TERMS
  REFUNDS
  SHIPPING
  COOKIES
  AUP
  CONTACT
}

enum ListingStatus {
  UNLISTED
  PENDING_REVIEW
  LISTED
  REJECTED
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum MessageIntent {
  TRANSACTIONAL
  MARKETING
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  STICKER
  LOCATION
  TEMPLATE
}

enum MetricPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum MigrationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  PAUSED
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETE
}

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PROCESSING
  FULFILLING
  OUT_FOR_DELIVERY
  SHIPPED
  DELIVERED
  CANCELLED
  REFUND_REQUESTED
  REFUNDED
  DISPUTED
}

enum OutboxEventStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

enum PaymentStatus {
  INITIATED
  PENDING
  VERIFIED
  SUCCESS
  FAILED
  REFUNDED
  DISPUTED
}

enum PolicyStatus {
  DRAFT
  PUBLISHED
}

enum PolicyType {
  TERMS
  PRIVACY
  RETURNS
  REFUNDS
  SHIPPING_DELIVERY
}

enum ReportEntityType {
  REVIEW
  STORE
  PRODUCT
}

enum ReportReason {
  SPAM
  FRAUD
  HATE
  HARASSMENT
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}

enum RestockAction {
  RESTOCK
  DISCARD
  REPAIR
  RETURN_TO_VENDOR
}

enum ReturnCondition {
  NEW
  OPENED
  DAMAGED
  MISSING_PARTS
  UNKNOWN
}

enum ReturnMethod {
  SELF_PICKUP
  DROPOFF
  CARRIER
}

enum ReturnReason {
  WRONG_ITEM
  DAMAGED
  NOT_AS_DESCRIBED
  SIZE_ISSUE
  CHANGED_MIND
  OTHER
}

enum ReturnResolution {
  REFUND
  EXCHANGE
  STORE_CREDIT
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  IN_TRANSIT
  RECEIVED
  INSPECTED
  COMPLETED
  CANCELLED
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  REJECTED
  HIDDEN
}

enum RiskScope {
  MERCHANT
  CUSTOMER
  ORDER
  CAMPAIGN
  MESSAGE
  PAYMENT
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
}

enum RiskStatus {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SubscriptionPlan {
  STARTER
  GROWTH
  PRO
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  PAUSED
}

enum SupportCaseCategory {
  PAYMENTS
  DELIVERY
  WHATSAPP
  CAMPAIGNS
  ACCOUNT
}

enum SupportCaseStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum ThemeCategory {
  MINIMAL
  FASHION
  ELECTRONICS
  BEAUTY
  FOOD
  SERVICES
  GENERAL
}

enum ThemeLicenseType {
  OWNED
  PERMISSIVE
}

enum ThemeStatus {
  DRAFT
  PUBLISHED
}

enum VirtualAccountStatus {
  NOT_CREATED
  CREATED
  FAILED
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  DEAD
}

enum WebhookEndpointStatus {
  ACTIVE
  DISABLED
}
